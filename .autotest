# WontoMedia -- a wontology web application
# Copyright (C) 2009 -- Glen E. Ivey
#    www.wontology.com
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License version
# 3 as published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program in the file COPYING and/or LICENSE.  If not,
# see <http://www.gnu.org/licenses/>.


require "autotest"

Autotest.add_hook :initialize do |at|

      # the default patterns provided by autotest for the Rails
      # directory structure don't work for us as-is.  The following
      # block completely replaces the contents of been unable to get
      # autotest's remove_mapping method to work,
      # ZenTest*/lib/autotest/rails.rb
  at.clear_mappings  # get rid of defaults

      # *on*top*of* defaults provided by autotest/rails.rb
      # primarily because we use git, but got this RE from the net, and most
      # of the other exclusions seem sensible, too
  at.add_exception %r%^\./(?:\.git|\.hg|\.svn|framework|gems|schema|\.DS_Store|autotest|bin|.*\.sqlite3)% 


      # for the basic Rails directory structure
  at.add_mapping %r%^app/models/(.*)\.rb$% do |_, m|
    "test/unit/#{m[1]}_test.rb"
  end

  at.add_mapping %r%^app/controllers/(.*)\.rb$% do |_, m|
    if m[1] == "application" then
      at.files_matching %r%^test/(views|functional|integration)/.*_test\.rb$%
    else
      a = [ "test/functional/#{m[1]}_test.rb" ]
      m[1] =~ /^(.+)_controller/
      c = Regexp.last_match[1]
      a.concat at.files_matching %r%^test/integration/.*#{c}.*_test\.rb$%
    end
  end

  # we do view testing, with tests located in their own test directory
  at.add_mapping %r%^app/views/(.+)\.html\.erb$% do |_, m|
    "test/views/#{m[1]}_test.rb"
  end

  # we do view-helper testing, with tests located in their own directory
  at.add_mapping %r%^app/helpers/(.+)\.rb$% do |_, m|
    "test/helpers/#{m[1]}_test.rb"
  end

  # we do route testing, with test files in the test/functional directory
  at.add_mapping %r%^config/routes\.rb$% do
    at.files_matching %r%^test/functional/.*routes?_test\.rb$%
  end




      # now other bits you might find in a Rails app.....
  at.add_mapping(/^lib\/.*\.rb$/) do |filename, _|
    base = File.basename(filename, '.rb')
    at.files_matching %r%^test/unit/#{base}_test\.rb$%
  end



      # and some structural stuff
  # if files with global effects change, rerun everything
  at.add_mapping %r%^config/((boot|environment(s/test)?)\.rb|database\.yml)% do
    at.files_matching %r%^test/.+_test\.rb$%
  end

  # if a test changes, run just that test
  at.add_mapping %r%^test/.*_test\.rb$% do |filename, _|
    filename
  end

  # if a test *helper.rb file changes, run all tests parallel-to and below it
  at.add_mapping %r%^test(.*)/[^/]*helper\.rb$% do |_, m|
    at.files_matching %r%^test#{m[1]}/.*_test\.rb$%
  end

  # tests that might be dependent on a fixture
  #   Note: may have multiple view tests dependent on a single fixture
  at.add_mapping %r%^test/fixtures/(.+)s\.yml$% do |_, m|
    ["test/unit/#{m[1]}_test.rb",
     "test/functional/#{m[1]}s_controller_test.rb" ].
        concat at.files_matching(%r%^test/views/#{m[1]}s/.*_test\.rb$%)
  end
end

require 'autotest/restart'
require 'autotest/redgreen'
require 'autotest/timestamp'
